<launch>
  <!-- Start kinect driver -->
  <include file="$(find freenect_launch)/launch/freenect.launch"></include>

  <!-- Start kinect depth frame converter to convert depth image from int millimetres to double metres -->
  <node pkg="nodelet" type="nodelet" args="manager" name="nodelet_manager" />
  <node pkg="nodelet" type="nodelet" name="convert_freenect_fovis" 
        args="load depth_image_proc/convert_metric nodelet_manager">
    <remap from="image_raw" to="/camera/depth/image_rect_raw"/>
    <remap from="image" to="/camera/depth_registered/image_rect"/>
  </node>

  <!-- Start ccny_rgbd itself -->
  <arg name="detector_type" default="GFT"/> # ORB, SURF, GFT, STAR
  <arg name="reg_type" default="ICPProbModel"/> # ICPProbModel

  <node pkg="ccny_rgbd" type="visual_odometry_node" name="visual_odometry_node" 
    output="screen">
    
    <remap from="/rgbd/depth" to="/camera/depth_registered/image_rect"/>
    <remap from="/rgbd/rgb"   to="/camera/rgb/image_rect_color"/>
    <remap from="/rgbd/info"  to="/camera/rgb/camera_info"/>
    

    #### diagnostics ##################################
        
    <param name="verbose"     value="false"/>    
    
    #### frames and tf output #########################
    
    <param name="publish_tf"  value="true"/>
    <param name="fixed_frame" value="/world"/>
    <param name="base_frame"  value="/camera_link"/>
       
    #### features #####################################
    
    #  ORB, SURF, or GFT (Good features to track)
    <param name="feature/detector_type"               value="$(arg detector_type)"/> 
    <param name="feature/smooth"                      value="0"/>
    <param name="feature/max_range"                   value="7.0"/>
    <param name="feature/max_stdev"                   value="0.05"/>
    <param name="feature/show_keypoints"              value="false"/>
    <param name="feature/publish_feature_cloud"       value="true"/>
    <param name="feature/publish_feature_covariances" value="false"/>

    #### features: GFT ################################

    <param name="feature/GFT/n_features"   value = "400"/>
    <param name="feature/GFT/min_distance" value = "2.0"/>

    #### features: SURF ###############################
  
    <param name="feature/SURF/threshold" value = "400"/>

    #### features: ORB ###############################
  
    <param name="feature/ORB/n_features" value = "300"/>
    <param name="feature/ORB/threshold"  value = "31"/>

    #### registration #################################

    <param name="reg/reg_type"          value="$(arg reg_type)"/>
    <param name="reg/motion_constraint" value="0"/>

    #### registration: ICP Prob Model #################

    <param name="reg/ICPProbModel/max_iterations"            value="10"/>
    <param name="reg/ICPProbModel/max_model_size"            value="5000"/>
    <param name="reg/ICPProbModel/n_nearest_neighbors"       value="4"/>
    <param name="reg/ICPProbModel/max_assoc_dist_mah"        value="10.0"/>
    <param name="reg/ICPProbModel/max_corresp_dist_eucl"     value="0.15"/>
    <param name="reg/ICPProbModel/publish_model_cloud"       value="true"/>
    <param name="reg/ICPProbModel/publish_model_covariances" value="false"/>
  </node>



#### KEYFRAME MAPPING ###################################

  <node pkg="ccny_rgbd" type="keyframe_mapper_node" name="keyframe_mapper_node" output="screen">
    <param name="fixed_frame" value="/world"/>

    <remap from="/rgbd/depth" to="/camera/depth_registered/image_rect"/>
    <remap from="/rgbd/rgb"   to="/camera/rgb/image_rect_color"/>
    <remap from="/rgbd/info"  to="/camera/rgb/camera_info"/>   
    
    <param name="kf_dist_eps"  value="0.25"/> <!-- 25 cm -->
    <param name="kf_angle_eps" value="0.35"/> <!-- 20 deg -->
    <param name="full_map_res" value="0.01"/>
    <param name="max_range" value="7.0"/>
    <param name="max_stdev" value="0.05"/>
  </node>



  <!-- Start rviz visualization with preset config -->
  <node pkg="rviz" type="rviz" name="rviz" args="-d $(find ccny_launch)/launch/ccny_rgbd-demo.rviz"/>

</launch>
